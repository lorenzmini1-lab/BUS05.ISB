<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Centre de Contr√¥le - Flotte</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        body{margin:0;padding:0;background:#111;font-family:sans-serif}
        #map{height:100vh;width:100%}
        .legend{position:fixed;top:10px;left:10px;z-index:1000;background:rgba(0,0,0,0.85);color:#fff;padding:12px;border-radius:8px;font-size:12px;border:1px solid #4da6ff;max-height:200px;overflow-y:auto}
        .bus-item{margin-bottom:5px;display:flex;align-items:center}
        .color-dot{width:10px;height:10px;border-radius:50%;margin-right:8px}
    </style>
</head>
<body>
    <div class="legend" id="legend"><b>üöå Flotte en direct</b><br><br></div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        // On r√©cup√®re "ids" (au pluriel) ou "id" (au singulier)
        const rawIds = params.get("ids") || params.get("id");
        const hostIds = rawIds ? rawIds.split(',') : [];
        
        let map = L.map('map').setView([46.6, 2.2], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        const fleet = {}; // Objet pour stocker les donn√©es de chaque bus
        const colors = ['cyan', 'lime', 'yellow', 'orange', 'magenta', 'red'];

        function getBusUI(id, color) {
            const div = document.createElement('div');
            div.className = 'bus-item';
            div.innerHTML = `<div class="color-dot" style="background:${color}"></div> <span>${id}: </span><b id="speed-${id}">0</b> km/h`;
            return div;
        }

        const peer = new Peer();

        peer.on('open', () => {
            hostIds.forEach((id, index) => {
                const color = colors[index % colors.length];
                
                // On cr√©e le marqueur et la ligne pour ce bus
                fleet[id] = {
                    marker: L.marker([0, 0]).addTo(map).bindPopup("Bus: " + id),
                    polyline: L.polyline([], {color: color, weight: 4}).addTo(map),
                    conn: peer.connect(id.trim())
                };

                // On ajoute √† la l√©gende
                document.getElementById('legend').appendChild(getBusUI(id, color));

                // Gestion des donn√©es re√ßues pour ce bus pr√©cis
                fleet[id].conn.on('data', (data) => {
                    if (data.command === "clearTrace") {
                        fleet[id].polyline.setLatLngs([]);
                        return;
                    }

                    const pos = [data.lat, data.lon];
                    fleet[id].marker.setLatLng(pos);
                    if (data.showTrace !== false) {
                        fleet[id].polyline.addLatLng(pos);
                    }
                    document.getElementById(`speed-${id}`).innerText = data.speed || 0;
                });
            });
        });

        // Bouton pour recadrer la vue sur tout le monde
        L.Control.extend({
            onAdd: function() {
                const btn = L.DomUtil.create('button', 'leaflet-bar');
                btn.innerHTML = 'üîç';
                btn.style.padding = '5px';
                btn.onclick = () => {
                    const group = new L.featureGroup(Object.values(fleet).map(f => f.marker));
                    if(group.getLayers().length > 0) map.fitBounds(group.getBounds());
                };
                return btn;
            },
            position: 'topright'
        }).addTo(map);
    </script>
</body>
</html>
