<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Suivi en direct</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        body{margin:0;padding:0;background:#111;font-family:sans-serif}
        #map{height:100vh;width:100%}
        .status{position:fixed;top:10px;left:10px;z-index:1000;background:rgba(0,0,0,0.85);color:#fff;padding:12px;border-radius:8px;font-size:12px;border:1px solid #4da6ff; min-width:150px}
        .speed-val{display:block; font-size:20px; color:#4da6ff; font-weight:bold; margin-top:5px}
        .dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; background: #28a745; box-shadow: 0 0 8px #28a745; }
    </style>
</head>
<body>
    <div class="status" id="status">
        <span class="dot"></span> <span id="text">Connexion...</span>
        <span id="speedDisplay" class="speed-val" style="display:none"><span id="speed">0</span> km/h</span>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        const hostId = params.get("id");
        const statusText = document.getElementById("text");
        const speedVal = document.getElementById("speed");
        const speedDisplay = document.getElementById("speedDisplay");
        
        let map = L.map('map', {zoomControl: false}).setView([0, 0], 2);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        let marker = L.marker([0, 0]).addTo(map);
        let polyline = L.polyline([], {color:'cyan', weight: 4}).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let userInteracting = false;
        let interactionTimer;
        map.on('movestart', () => { userInteracting = true; clearTimeout(interactionTimer); });
        map.on('moveend', () => { interactionTimer = setTimeout(() => { userInteracting = false; }, 5000); });

        function connect() {
            if (!hostId) return statusText.innerText = "❌ ID manquant";
            const peer = new Peer();
            peer.on('open', () => {
                const conn = peer.connect(hostId);
                conn.on('open', () => { statusText.innerText = "Connecté !"; });
                conn.on('data', (data) => {
                    // Si on reçoit l'ordre d'effacer le tracé
                    if (data.command === "clearTrace") {
                        polyline.setLatLngs([]); // On vide la ligne
                        return;
                    }

                    const pos = [data.lat, data.lon];
                    marker.setLatLng(pos);
                    
                    if (data.showTrace !== false) {
                        polyline.addLatLng(pos);
                    } else {
                        polyline.setLatLngs([]); // Sécurité supplémentaire : si désactivé, on vide
                    }
                    
                    speedDisplay.style.display = "block";
                    speedVal.innerText = data.speed || 0;
                    if (!userInteracting) {
                        map.setView(pos, map.getZoom() < 10 ? 17 : map.getZoom());
                    }
                    statusText.innerText = "DIRECT - " + new Date(data.time).toLocaleTimeString();
                });
                conn.on('close', () => { 
                    statusText.innerText = "Signal perdu..."; 
                    speedDisplay.style.display = "none";
                    setTimeout(connect, 4000); 
                });
            });
        }
        connect();
    </script>
</body>
</html>
